<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" type="image/png" href="https://i.imgur.com/uGijtpF.png" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
/* ===== Layout & background ===== */
*{box-sizing:border-box}
html, body { height:100%; }
body{
  margin:0; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  background: url('https://i.imgur.com/UCZqSrT.png') no-repeat center/cover fixed;
  display:flex; align-items:center; justify-content:center;
  min-height:100svh;
  /* safe area iOS */
  padding: env(safe-area-inset-top) env(safe-area-inset-right)
           env(safe-area-inset-bottom) env(safe-area-inset-left);
}

/* ===== Login Card ===== */
.login-box{
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  width:min(450px, 92vw);
  padding:32px 20px;
  border:1px solid gold; border-radius:12px;
  box-shadow:0 0 8px rgba(255,215,0,.6);
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  transition: transform .25s ease, box-shadow .25s ease;
  will-change: transform, box-shadow, backdrop-filter;
}
.login-box:hover{ transform:scale(1.03); box-shadow:0 0 18px rgba(255,215,0,.9); }

.login-box img{
  max-width: 86%;
  height:auto;
  margin: 0 0 20px 0;
  display:block;
}

.login-btn{
  background:#FFD700; color:#000;
  border:2px solid gold; border-radius:8px;
  padding:12px 20px; font-size:18px; font-weight:600;
  cursor:pointer; display:block; margin:0 auto;
  min-height:44px;            /* touch target nyaman */
  transition: background .2s ease, color .2s ease, border-color .2s ease, transform .12s ease;
}
.login-btn:hover{ background:rgba(255,255,255,.1); color:#fff; border-color:#fff; }
.login-btn:active{ transform:scale(.98); }
.login-btn[disabled]{ opacity:.6; cursor:not-allowed; }

/* ===== Keyframes ===== */
@keyframes zoomIn { from{transform:scale(.7);opacity:0;} to{transform:scale(1);opacity:1;} }
.zoom-in{ animation: zoomIn .3s ease forwards; }

/* ===== Welcome Popup ===== */
.popup-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.7);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
}
.popup-box{
  position:relative; width:min(550px,92vw);
  border:1px solid gold; border-radius:12px;
  padding:28px 16px 22px;
  text-align:center;
  box-shadow:0 0 10px rgba(255,215,0,.7);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  background: rgba(0,0,0,.4);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.popup-title{ font-size:28px; font-weight:800; color:gold; margin:8px 0 14px; }
.popup-box img{ max-width:80%; height:auto; margin:0 0 16px; }
.popup-btn{
  background:transparent; color:gold; border:1px solid gold;
  padding:10px 18px; border-radius:8px; font-weight:600; cursor:pointer;
  min-height:44px; transition: all .2s ease;
}
.popup-btn:hover{ background:gold; color:#111; }
.popup-close{
  position:absolute; top:10px; right:10px;
  background:transparent; border:none; color:gold; font-weight:800; cursor:pointer;
  padding:6px 10px; border-radius:8px; line-height:1;
}
.popup-close:hover{ color:#ffe34d; }

/* ===== Blocked Popup (glass) ===== */
.blocked-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10000; }
.blocked-overlay.show{ display:flex; }
/* gelapkan layar via filter supaya blur terlihat */
.blocked-overlay::before{
  content:""; position:fixed; inset:0;
  backdrop-filter: brightness(.55);
  -webkit-backdrop-filter: brightness(.55);
  pointer-events:none;
}
.blocked-box{
  position:relative; width:min(520px,92vw);
  border:1px solid gold; border-radius:12px;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  box-shadow:0 0 14px rgba(255,215,0,.6);
  padding:26px 22px 20px; color:#fff; text-align:left;
  animation: zoomIn .25s ease forwards;
}
.blocked-close{
  position:absolute; top:10px; right:10px; background:transparent; border:none;
  color:gold; font-weight:800; cursor:pointer;
}
.blocked-title{ margin:6px 6px 2px; font-size:26px; font-weight:700; color:#d50000; }
.blocked-sub{ margin:0 6px 12px; color:#f1f5f9; opacity:.9; }
.blocked-info{
  margin:8px 6px 18px; padding:12px; border:1px dashed #d50000; border-radius:10px;
  background: rgba(0,0,0,.35); font-size:14px; line-height:1.5; color:#e5e7eb;
}
.blocked-actions{ display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:6px; }
.btn{
  border-radius:8px; padding:10px 14px; font-size:14px; cursor:pointer;
  border:1px solid gold; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
  min-height:40px; transition: all .2s ease;
}
.btn.ghost{ background:transparent; color:gold; }
.btn.ghost:hover{ color:#ffe34d; }
.btn.solid{ background:gold; color:#111; font-weight:800; }
.btn.solid:hover{ background:#ffe34d; }

/* ===== Mobile tweaks ===== */
@media (max-width:480px){
  .login-box{ padding:24px 14px; }
  .login-box img{ max-width:78%; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .zoom-in, .login-box{ animation:none; transition:none; }
}
  </style>
</head>
<body>

  <!-- Welcome popup -->
  <div class="popup-overlay" id="popup">
    <div class="popup-box zoom-in" id="popupBox" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
      <button class="popup-close" onclick="closePopup()" aria-label="Close">✕</button>
      <p id="welcomeTitle" class="popup-title">Welcome to 5G88!</p>
      <img src="https://api.5g88.homes/media/LOADING_GIF.webp" alt="5G88 Logo">
      <button class="popup-btn" onclick="closePopup()">OK</button>
    </div>
  </div>

  <!-- Blocked popup -->
  <div class="blocked-overlay" id="blockedPopup" aria-hidden="true">
    <div class="blocked-box" role="dialog" aria-modal="true" aria-labelledby="blockedTitle" tabindex="-1">
      <button class="blocked-close" onclick="hideBlockedPopup()" aria-label="Close">✕</button>
      <h2 id="blockedTitle" class="blocked-title">Access Denied</h2>
      <p class="blocked-sub">You need permission to access 5G88.</p>
      <div id="blockedInfo" class="blocked-info"></div>
      <div class="blocked-actions">
        <button class="btn ghost" onclick="hideBlockedPopup()">Cancel</button>
        <a class="btn solid" id="contactBtn" href="mailto:support@5g88.local">Contact us</a>
      </div>
    </div>
  </div>

  <!-- Login card -->
  <div class="login-box" role="region" aria-label="Login">
    <img src="https://i.imgur.com/QrxyBjc.png" alt="5G88 x EVO VIP">
    <button class="login-btn" id="googleLoginBtn" aria-label="Login with Google">Login with Google</button>
  </div>

<script>
/* ===== Popup helpers ===== */
function closePopup(){ document.getElementById("popup").style.display="none"; }
function hideBlockedPopup(){
  const overlay = document.getElementById('blockedPopup');
  overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
}
function showBlockedPopup(user){
  const infoEl = document.getElementById('blockedInfo');
  const email = user?.email || '—';
  const name  = user?.displayName || '—';
  infoEl.innerHTML = `
    <div><strong>User:</strong> ${name}</div>
    <div><strong>Email:</strong> ${email}</div>
    <div style="margin-top:10px">If you believe this is a mistake, please contact admin to request access.</div>
  `;

  const contactBtn = document.getElementById('contactBtn');
  contactBtn.textContent = 'Contact us on Telegram';
  contactBtn.href = 'https://t.me/Kiwi5G88';
  contactBtn.target = '_blank';
  contactBtn.rel = 'noopener';
  contactBtn.onclick = (e) => {
    e.preventDefault();
    const webLink = 'https://t.me/Kiwi5G88';
    const tgScheme = 'tg://resolve?domain=Kiwi5G88';
    const androidIntent =
      'intent://resolve?domain=Kiwi5G88#Intent;scheme=tg;package=org.telegram.messenger;'
      + 'S.browser_fallback_url=' + encodeURIComponent(webLink) + ';end';
    const ua = navigator.userAgent;
    const isAndroid = /Android/i.test(ua);
    const isIOS     = /iPhone|iPad|iPod/i.test(ua);
    if (isAndroid){ location.href = androidIntent; return; }
    if (isIOS){
      let done=false;
      const t=setTimeout(()=>{ if(!done){ done=true; location.href=webLink; } },800);
      location.href=tgScheme;
      addEventListener('pagehide', ()=>{ done=true; clearTimeout(t); }, {once:true});
      return;
    }
    window.open(webLink,'_blank','noopener');
  };

  const overlay = document.getElementById('blockedPopup');
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
  overlay.querySelector('.blocked-box').focus();
}

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCZ9zUxDf3V9TvI3vOdgeZD7pLE4IuPrOE",
  authDomain: "logins-d615f.firebaseapp.com",
  databaseURL: "https://logins-d615f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "logins-d615f",
  storageBucket: "logins-d615f.appspot.com",
  messagingSenderId: "580872784703",
  appId: "1:580872784703:web:07957551c3214f3d32618a"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ===== Helpers ===== */
function formatTimestamp(date){
  const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,'0'), d=String(date.getDate()).padStart(2,'0');
  const hh=String(date.getHours()).padStart(2,'0'), mm=String(date.getMinutes()).padStart(2,'0'), ss=String(date.getSeconds()).padStart(2,'0');
  return `${y} - ${m} - ${d} ${hh}:${mm}:${ss}`;
}
function sanitizeEmailKey(email){ return String(email || '').replace(/\./g,'_'); }

/* ===== Post-login flow (shared for popup/redirect) ===== */
async function handleSignedInUser(user){
  if(!user) return;
  const emailKey = sanitizeEmailKey(user.email);
  const snap = await db.ref("logins/blocked_users/" + emailKey).get();
  if (snap.exists() && snap.val() === true){
    showBlockedPopup(user);
    await auth.signOut();
    setLoginBtnIdle();
    return;
  }
  await db.ref("logins/" + emailKey).set({
    name: user.displayName, email: user.email, loginAt: formatTimestamp(new Date())
  });
  localStorage.setItem("gmailLogin", JSON.stringify({
    name: user.displayName, email: user.email, photo: user.photoURL
  }));
  const name = encodeURIComponent(user.displayName || "");
  const email= encodeURIComponent(user.email || "");
  const photo= encodeURIComponent(user.photoURL || "");
  location.href = `https://5g88-main.vercel.app/?name=${name}&email=${email}&photo=${photo}`;
}

/* ===== Sign-in with popup + fallback redirect ===== */
function setLoginBtnBusy(){ const b=document.getElementById('googleLoginBtn'); b.disabled=true; b.innerText='Logging in...'; }
function setLoginBtnIdle(){ const b=document.getElementById('googleLoginBtn'); b.disabled=false; b.innerText='Login with Google'; }

async function signInWithGoogle(){
  setLoginBtnBusy();
  const provider = new firebase.auth.GoogleAuthProvider();

  // deteksi iOS / in-app browser (popup sering diblok)
  const ua = navigator.userAgent;
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isInApp = /(FBAN|FBAV|FB_IAB|Instagram|Line|MiuiBrowser)/i.test(ua);

  try{
    if (isIOS || isInApp){
      await auth.signInWithRedirect(provider);
      return; // halaman akan redirect; sisa flow di getRedirectResult
    }
    const res = await auth.signInWithPopup(provider);
    await handleSignedInUser(res.user);
  }catch(err){
    // fallback ke redirect kalau popup gagal (blocked)
    try{
      await auth.signInWithRedirect(provider);
    }catch(err2){
      console.error("❌ Login gagal:", err2);
      alert("Login gagal. Coba lagi.");
      setLoginBtnIdle();
    }
  }
}

/* Tangkap hasil redirect ketika kembali dari Google */
auth.getRedirectResult().then(async (res)=>{
  if(res && res.user){ await handleSignedInUser(res.user); }
}).catch(err=>{
  console.error("❌ Redirect error:", err);
  setLoginBtnIdle();
});

/* ===== Wire up ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  const loginBtn = document.getElementById("googleLoginBtn");
  if (loginBtn) loginBtn.addEventListener("click", signInWithGoogle, {passive:true});
});
</script>
</body>
</html>
