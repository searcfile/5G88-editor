<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="icon" type="image/png" href="https://i.imgur.com/uGijtpF.png" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
/* ===== Base & Layout ===== */
*, *::before, *::after { box-sizing: border-box; }   /* anti overflow */
html, body { height: 100%; }
body{
  background: url('https://i.imgur.com/UCZqSrT.png') no-repeat center/cover fixed;
  color:#fff; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
  margin:0; display:flex; align-items:center; justify-content:center; min-height:100svh;
}

/* ===== Login Card ===== */
.login-box{
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  width:520px; max-width:92vw;
  margin:0; padding:36px 22px 28px;
  border:1px solid gold; border-radius:16px;
  background-color:#141414;
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  box-shadow:0 0 8px rgba(255,215,0,.6);
  transition: transform .3s ease, box-shadow .3s ease;
  overflow:hidden;                        /* jaga-jaga biar tak keluar */
}
.login-box img { max-width: 100%; width:360px; height:auto; margin: -10px auto 18px; display:block; }

/* ===== Tabs (Username / Google) ===== */
.tabs{ display:flex; gap:12px; width:100%; margin:6px 0 16px; }
.tab{
  flex:1; text-align:center; padding:12px 14px; border:1px solid gold; border-radius:999px;
  cursor:pointer; user-select:none; transition:.2s;
  background:rgba(0,0,0,.35); color:gold; font-weight:700; font-size:14px;
}
.tab:hover{background:gold;color:black;}.tab.active{ background:gold; color:#111; box-shadow:0 0 8px rgba(255,215,0,.45) inset; }
.form{ width:100%; display:none; }
.form.active{ display:block; }

/* ===== Inputs & Buttons ===== */
.group{ margin-bottom:12px; width:100%; max-width:100%; }
.label{ display:block; font-size:13px; color:#ffd700; margin-bottom:6px; }

.input{
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  border:1px solid #ffd700;
  background:rgba(0,0,0,.35);
  color:#fff; outline:none;
  transition: border-color .2s, box-shadow .2s, background .2s;
}
.input::placeholder{ color:#d1d5db; opacity:.9; }
.input:focus{
  border-color:#fff;
  box-shadow:0 0 0 3px rgba(255,255,255,.12), 0 0 10px rgba(255,215,0,.35);
  background:rgba(0,0,0,.28);
}

/* ===== Password eye (tengah tepat) ===== */
.password-wrap { /* boleh kosong atau biarkan seperti ini */ }
.password-wrap .field {              /* NEW */
  position: relative;
}
.password-wrap .field .input{ padding-right:46px; }          /* ruang untuk icon */
.toggle-eye{
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px; height: 28px;
  display: grid; place-items: center;
  border: 0; background: transparent; color: gold;
  cursor: pointer; line-height: 0;
}
.toggle-eye:focus{ outline:none; }
.toggle-eye svg{ width:20px; height:20px; display:block; }

/* ===== Buttons ===== */
.btn,
.login-btn{
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  border:2px solid gold;
  background:#FFD700; color:#000;
  font-size:16px; font-weight:800; cursor:pointer; transition:.2s;
}
.btn:hover, .login-btn:hover{
  background:rgba(255,255,255,.1); color:#fff; border-color:#fff;
}
.btn-req{width:100%;padding:12px 14px;margin-top:10px;border-radius:8px;border:1px solid gold;background:gold; color:#000;font-size:14px; cursor:pointer;font-weight:bold; transition:.2s;}
.btn-req:hover{background:#ffe34d;}.btn-req:active{background:#dbb900;}
.btn-cfp:hover{ color:#fff; border-color:#fff;}.btn-cfp:active{ color:rgba(255,255,255,0.65); border-color:rgba(255,255,255,0.65);}
.btn-cfp{width:100%;padding:12px 14px;margin-top:10px;border-radius:8px;border:1px solid gold;background:transparent; color:gold;font-size:14px;cursor:pointer; transition:.2s;}

/* ===== Welcome Popup123 ===== */
@keyframes zoomIn{ from{transform:scale(.7);opacity:0} to{transform:scale(1);opacity:1} }
.zoom-in{ animation: zoomIn .3s ease forwards; }
.popup-overlay{
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: flex; align-items: center; justify-content: center; z-index: 9999;
}
#popupBox{ position: relative; }
#popupBox .popup-btn{
  position: absolute;
  left: 11px;          /* samakan dengan padding kiri */
  right: 11px;         /* samakan dengan padding kanan */
  bottom: 15px;         /* seberapa dekat ke tepi bawah */
  width: auto;         /* biar ikut left/right */
  margin-top: 0;
  border-radius:6px;height:40px;
  background:gold;color:black;transition:.2s;font-weight:bold;
}
.popup-btn:hover{ background:#ffe34d !important;}.popup-btn:active{ background:#dbb900 !important;}
.popup-box{
  border: 1px solid gold; border-radius: 12px; padding: 40px 20px 30px; text-align: center; position: relative;
  width:min(520px,92vw); min-height: 500px; box-shadow: 0 0 10px rgba(255,215,0,.7);
  background-color: rgba(0,0,0,0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
}
.popup-box img {max-width: 280px; margin-bottom: 18px;}
.popup-title { font-size: 26px; font-weight: 800; margin: 0 0 10px; color: gold;text-shadow: 0 0 #000000; }
.popup-btn{
  border:1px solid gold; background:transparent; color: gold; padding: 10px 20px; border-radius: 8px; cursor:pointer; transition:.2s;
}

.btn-contact{background:gold; color: black; padding: 10px 20px; border-radius: 6px;text-decoration:none; cursor:pointer; transition:.2s;}
.btn-contact:hover{background:#ffe34d;}.btn-contact:active{background:#dbb900;}
.btn-cancel{border:1px solid gold; background:transparent; color: gold; padding: 10px 20px; border-radius: 6px; cursor:pointer; transition:.2s;}
.btn-cancel:hover{border:1px solid #ffe34d;color: #ffe34d;}.btn-cancel:active{border:1px solid #dbb900;color:#dbb900;}
/* === Posisi tombol X di pojok kanan atas === */
.popup-box .popup-close,
.blocked-box .popup-close{
  position: absolute;
  top: 10px;
  right: 10px;
  width: 32px; height: 32px;
  display: grid; place-items: center;
  border: 0; background: transparent;
  color: gold; cursor: pointer;
  line-height: 1; font-size: 14px;   /* ikon ✕ jelas */
  border-radius: 8px;
  z-index: 1;
  transition:.2s;
}
/* beri ruang kanan agar X tidak menimpa judul/konten */
.popup-box,
.blocked-box{
  padding-right: 24px !important;   /* samakan dengan kiri */
  padding-left: 24px !important;    /* (opsional) biar simetris */
  padding-top: 56px !important;     /* ruang aman untuk tombol X */
}
.popup-close:hover{color:#ffe34d; }.popup-close:active{color:#dbb900; }
/* ===== Blocked Popup ===== */
.blocked-overlay::before{
  content:""; position: fixed; inset: 0; backdrop-filter: brightness(.55); -webkit-backdrop-filter: brightness(.55); pointer-events: none;
}
.blocked-overlay{ position:fixed; inset:0; background:transparent; display:none; align-items:center; justify-content:center; z-index:10000; }
.blocked-overlay.show{ display:flex; }
.blocked-box{
  position:relative; width:min(650px, 92vw);
  border:1px solid gold; border-radius:12px; background:rgba(0,0,0,.45);
  backdrop-filter: blur(12px) !important; -webkit-backdrop-filter: blur(12px) !important;
  box-shadow:0 0 14px rgba(255,215,0,.6);
  padding:26px 22px 20px; animation: zoomIn .25s ease forwards; color:#fff; text-align:left;
}
.blocked-title{ margin:6px 6px 2px; font-size:26px; font-weight:700; color:#d50000; }
.blocked-sub{ margin:0 6px 12px; color:#f1f5f9; opacity:.9; }
.blocked-info{
  margin:8px 6px 18px; padding:12px; border:1px dashed #d50000; border-radius:10px;
  background: #111; font-size:14px; line-height:1.5; color:rgba(255,255,255,0.85);
}
.blocked-actions{ display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:6px; }


/* ===== Small screens ===== */
@media (max-width: 480px){
  .login-box{ padding:28px 16px 24px; border-radius:14px; }
  .tab{ font-size:13px; padding:10px 12px; }
  .input, .btn{ padding:12px; }
}
/* === Forgot Password UI === */
.forgot-row{ width:100%; display:flex; justify-content:flex-end; margin:6px 0 10px; }
.link-btn{ background:transparent; border:0; color:gold; font-size:13px; cursor:pointer; text-decoration:underline; padding:0; }
.link-btn:hover{ opacity:.85; }

.err-msg{ color:#ff4d4f; font-size:12px; margin-top:6px; }
.input.invalid{ border-color:#ff4d4f !important; box-shadow:0 0 0 3px rgba(255,77,79,.2); }

.forgot-box{ width:min(650px,92vw); text-align:left; align-items:stretch; }
.actions-row{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
#forgotOverlay .popup-close{ top:12px; right:12px; }
  /* Livechat floating widget */
  .lc-wrap{position:fixed; right:16px; bottom:16px; z-index:9999; font-family:inherit;}
  .lc-btn{
    display:flex; align-items:center; gap:8px;
    padding:10px 14px; border-radius:999px; border:1px solid gold;
    background:gold; color:#000; font-weight:700; cursor:pointer;
    box-shadow:0 4px 14px rgba(0,0,0,.25);
  }
  .lc-btn:hover{ filter:brightness(1.05); }
  .lc-dot{ width:8px; height:8px; background:#ff3b30; border-radius:50%; display:none; }

  .lc-panel{
    position:absolute; right:0; bottom:56px; width:min(420px, 92vw); height:520px;
    background:#111; border:1px solid #333; border-radius:12px; overflow:hidden;
    box-shadow:0 12px 40px rgba(0,0,0,.45); display:none;
  }
  .lc-panel.active{ display:block; }
  .lc-iframe{ width:100%; height:100%; border:0; }
  </style>
</head>
<body>

  <!-- Welcome popup -->
  <div class="popup-overlay" id="popup">
    <div class="popup-box" id="popupBox">
      <button class="popup-close" onclick="closePopup()">✕</button>
      <p class="popup-title">Welcome to 5G88!</p>
      <img src="https://api.5g88.homes/media/LOADING_GIF.webp" alt="5G88 Logo" class="popup-logo">
      <div style="font-size:12px; opacity:.9; text-align:center;">
      By continuing, you agree to our Terms and acknowledge our Privacy Policy.
    </div>
      <button class="popup-btn" onclick="closePopup()">OK</button>
    </div>
  </div>

  <!-- BLOCKED POPUP -->
  <div class="blocked-overlay" id="blockedPopup" aria-hidden="true">
    <div class="blocked-box" role="dialog" aria-modal="true" aria-labelledby="blockedTitle" tabindex="-1">
      <button class="popup-close" onclick="hideBlockedPopup()" aria-label="Close">✕</button>
      <h2 id="blockedTitle" class="blocked-title">Access Denied</h2>
      <p class="blocked-sub">You need permission to access 5G88.</p>
      <div id="blockedInfo" class="blocked-info"></div>
      <div class="blocked-actions">
        <button class="btn-cancel" onclick="hideBlockedPopup()">Cancel</button>
        <a class="btn-contact" id="contactBtn" href="mailto:support@5g88.local">Contact us</a>
      </div>
    </div>
  </div>

  <div class="login-box">
    <img src="https://i.imgur.com/QrxyBjc.png" alt="5G88 Logo">

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" id="tab-userpass">Username Login</div>
      <div class="tab" id="tab-google">Google Login</div>
    </div>

    <!-- Username/Password Form -->
    <form id="form-userpass" class="form active">
      <div class="group">
        <label class="label" for="username">Username</label>
        <input class="input" id="username" autocomplete="username" placeholder="Your username" required>
      </div>
<div class="group password-wrap">
  <label class="label" for="password">Password</label>

  <div class="field">
    <input class="input" id="password" type="password"
           autocomplete="current-password" placeholder="Your password" required>

    <button type="button" class="toggle-eye" id="eyeBtn"
            aria-label="Show password" aria-pressed="false" data-state="hide">
      <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
        <path id="eyePath" fill="currentColor"
          d="M15 12c0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3 3 1.346 3 3zm9-.449s-4.252 8.449-11.985 8.449c-7.18 0-12.015-8.449-12.015-8.449s4.446-7.551 12.015-7.551c7.694 0 11.985 7.551 11.985 7.551zm-7 .449c0-2.757-2.243-5-5-5s-5 2.243-5 5 2.243 5 5 5 5-2.243 5-5z"/>
      </svg>
    </button>
  </div>
</div>
<div class="forgot-row">
  <button type="button" id="forgotBtn" class="link-btn">Forgot password?</button>
</div>
      <button class="btn" id="btnUserpass">Login</button>
      <!-- (Opsional) Buat akaun baru -->
      <!-- <button type="button" class="btn ghost" onclick="createAccount()">Create Account</button> -->
    </form>

    <!-- Google Login Form -->
    <div id="form-google" class="form">
      <button class="btn" id="googleLoginBtn">Login with Google</button>
    </div>

    <div class="sep"><span>or</span></div>
    <div style="font-size:12px; opacity:.9; text-align:center;">
      By continuing, you agree to our Terms and acknowledge our Privacy Policy.
    </div>
  </div>
<!-- FORGOT PASSWORD POPUP -->
<div id="forgotOverlay" class="blocked-overlay" aria-hidden="true">
  <div class="blocked-box forgot-box zoom-in" role="dialog" aria-modal="true">
    <button class="popup-close" id="forgotClose" aria-label="Close">✕</button>
    <h3 class="popup-title" style="margin-bottom:14px">Forgot Password</h3>

    <div class="group">
      <label class="label" for="fpUsername">Username register</label>
      <input id="fpUsername" class="input" placeholder="Username">
      <div id="fpUserErr" class="err-msg" style="display:none">Username not register</div>
    </div>

    <div class="group" style="margin-bottom:6px">
      <label class="label" for="fpNote">Optional (forgot password)</label>
      <input id="fpNote" class="input" placeholder="(opsional)">
    </div>

    <div class="actions-row">
      <button id="fpCancel" class="btn-cfp" type="button">Cancel</button>
      <button id="fpRequest" class="btn-req" type="button">Request</button>
    </div>
  </div>
</div>
<!-- Live Chat floating widget -->
<div class="lc-wrap" id="lcWrap">
  <button class="lc-btn" id="lcToggle">
    <span>Live Chat</span>
    <span class="lc-dot" id="lcDot"></span>
  </button>
  <div class="lc-panel" id="lcPanel" aria-hidden="true">
    <iframe id="lcFrame" class="lc-iframe" title="Live Chat"></iframe>
  </div>
</div>
<script>
/* ====== Popup welcome ====== */
function closePopup(){ document.getElementById("popup").style.display="none"; }
window.addEventListener("click", (e) => {
  const overlay = document.getElementById("popup");
  if (e.target === overlay) overlay.style.display = "none";
});
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("popupBox")?.classList.add("zoom-in");
});

/* ====== Firebase Config ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCZ9zUxDf3V9TvI3vOdgeZD7pLE4IuPrOE",
  authDomain: "logins-d615f.firebaseapp.com",
  databaseURL: "https://logins-d615f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "logins-d615f",
  storageBucket: "logins-d615f.appspot.com",
  messagingSenderId: "580872784703",
  appId: "1:580872784703:web:07957551c3214f3d32618a"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ===== Helpers (dipakai lintas fitur, diletak di awal agar siap pakai) ===== */
const MAIN_URL = "https://5g88-main.vercel.app";
const toPseudoEmail = (uname) => `${String(uname || '').trim()}@5g88.local`;
const sanitizeKey = (email) => String(email || '').replace(/\./g, "_");
function formatTimestamp(date){
  const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,'0'), d=String(date.getDate()).padStart(2,'0');
  const hh=String(date.getHours()).padStart(2,'0'), mm=String(date.getMinutes()).padStart(2,'0'), ss=String(date.getSeconds()).padStart(2,'0');
  return `${y} - ${m} - ${d} ${hh}:${mm}:${ss}`;
}

/* ===== Forgot Password (final) ===== */
const PATH_RESET = 'password_reset_requests';
const USERNAME_INDEX = 'user_index/usernames';
// Elemen
const forgotOverlay = document.getElementById('forgotOverlay'); // gunakan class="blocked-overlay"
const forgotClose   = document.getElementById('forgotClose');
const forgotBtn     = document.getElementById('forgotBtn');
const fpCancel      = document.getElementById('fpCancel');
const fpRequest     = document.getElementById('fpRequest');
const fpUserInput   = document.getElementById('fpUsername');
const fpUserErr     = document.getElementById('fpUserErr');
const fpNote        = document.getElementById('fpNote');

// Utils
const _sanitizeUsername = (u)=> (u || '').trim().toLowerCase().replace(/[^a-z0-9._-]/g,'');
function _clearFpErr(){ if(fpUserInput){ fpUserErr.style.display='none'; fpUserInput.classList.remove('invalid'); } }

// Open/close (pakai gaya "blocked")
function openForgot(){
  // tutup welcome kalau masih terbuka agar tidak dobel layer
  const welcome = document.getElementById('popup');
  if (welcome) welcome.style.display = 'none';

  if (forgotOverlay){
    if (forgotOverlay.classList.contains('blocked-overlay')) {
      forgotOverlay.classList.add('show');
    } else {
      // fallback jika belum ganti class di HTML
      forgotOverlay.style.display = 'flex';
    }
    forgotOverlay.removeAttribute('hidden');
    forgotOverlay.setAttribute('aria-hidden','false');
  }
  setTimeout(()=> fpUserInput?.focus(), 10);

  const esc = (e)=>{ if (e.key === 'Escape') closeForgot(); };
  document.addEventListener('keydown', esc, { once:true });
}
function closeForgot(){
  if (!forgotOverlay) return;
  if (forgotOverlay.classList.contains('blocked-overlay')){
    forgotOverlay.classList.remove('show');
  } else {
    forgotOverlay.style.display = 'none';
  }
  forgotOverlay.setAttribute('aria-hidden','true');
  forgotOverlay.setAttribute('hidden','');

  if (fpUserInput) fpUserInput.value = '';
  if (fpNote)      fpNote.value = '';
  _clearFpErr();
}

// Cek di RTDB dulu, Auth jadi fallback saja
async function usernameExists(uname){
  const u = _sanitizeUsername(uname);
  if (!u) return null;

  // 1) Cek index di RTDB (paling akurat & cepat)
  try{
    const snap = await db.ref(`${USERNAME_INDEX}/${u}`).once('value');
    const v = snap.val();
    if (v === true || v === 'true') return true;   // boolean true (atau string 'true')
  }catch(e){
    console.warn('index read failed:', e);
  }

  // 2) Fallback ke Auth; kalau tidak yakin → return null (jangan merah)
  try{
    const methods = await auth.fetchSignInMethodsForEmail(toPseudoEmail(u));
    return (Array.isArray(methods) && methods.includes('password')) ? true : null;
  }catch(e){
    console.warn('fetchSignInMethodsForEmail failed:', e?.code || e);
    return null; // unknown → jangan blok user
  }
}

// Event bindings
forgotBtn?.addEventListener('click', openForgot);
forgotClose?.addEventListener('click', closeForgot);
fpCancel?.addEventListener('click', closeForgot);
forgotOverlay?.addEventListener('click', (e)=>{ if (e.target === forgotOverlay) closeForgot(); });
fpUserInput?.addEventListener('input', _clearFpErr);

// Validasi on blur (render merah hanya jika yakin tidak ada)
fpUserInput?.addEventListener('blur', async () => {
  const u = _sanitizeUsername(fpUserInput.value);
  if (!u) return;
  const ok = await usernameExists(u); // true/false/null
  if (ok === false){
    fpUserErr.style.display = 'block';
    fpUserInput.classList.add('invalid');
  } else {
    _clearFpErr(); // ok===true atau null (unknown) → jangan merah
  }
});

// Submit request
fpRequest?.addEventListener('click', async () => {
  const u = _sanitizeUsername(fpUserInput.value);
  const note = (fpNote?.value || '').trim();
  if (!u){ fpUserInput?.focus(); return; }

  const ok = await usernameExists(u); // true/false/null
  if (ok === false){
    fpUserErr.style.display = 'block';
    fpUserInput.classList.add('invalid');
    return;
  }

  try{
    fpRequest.disabled = true;
    await db.ref(PATH_RESET).push({
      username: u,
      email: toPseudoEmail(u),
      note,
      createdAt: Date.now(),
      status: 'pending',
      verify: ok === true ? 'exists' : 'unknown',  // catat hasil verifikasi
      ua: navigator.userAgent
    });
    alert('Request successfully. New password will procces.');
    closeForgot();
  }catch(e){
    console.error(e);
    alert('Request error. Try again.');
  }finally{
    fpRequest.disabled = false;
  }
});

/* ===== Blocked Popup (biarkan seperti semula) ===== */
function showBlockedPopup(user){
  const infoEl = document.getElementById('blockedInfo');
  const email = user?.email || '';
  const name  = user?.displayName || user?.email?.split('@')?.[0] || '';
  infoEl.innerHTML = `
    <div><strong>User:</strong> ${name || '—'}</div>
    <div><strong>Email:</strong> ${email || '—'}</div>
    <div style="margin-top:10px">If you believe this is a mistake, please contact admin to request access.</div>
  `;

  const contactBtn = document.getElementById('contactBtn');
  contactBtn.textContent = 'Contact us on Telegram';
  contactBtn.href = 'https://t.me/Kiwi5G88';
  contactBtn.target = '_blank';
  contactBtn.rel = 'noopener';
  contactBtn.onclick = (e) => {
    e.preventDefault();
    const webLink = 'https://t.me/Kiwi5G88';
    const tgScheme = 'tg://resolve?domain=Kiwi5G88';
    const androidIntent =
      'intent://resolve?domain=Kiwi5G88#Intent;scheme=tg;package=org.telegram.messenger;' +
      'S.browser_fallback_url=' + encodeURIComponent(webLink) + ';end';
    const ua = navigator.userAgent;
    const isAndroid = /Android/i.test(ua);
    const isIOS     = /iPhone|iPad|iPod/i.test(ua);
    if (isAndroid) { window.location.href = androidIntent; return; }
    if (isIOS) {
      let done=false; const t=setTimeout(()=>{ if(!done){done=true; window.location.href=webLink;} },800);
      window.location.href = tgScheme;
      window.addEventListener('pagehide', ()=>{ done=true; clearTimeout(t); }, {once:true});
      return;
    }
    window.open(webLink,'_blank','noopener');
  };

  const overlay = document.getElementById('blockedPopup');
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
  overlay.querySelector('.blocked-box')?.focus();
  const escHandler = (e)=>{ if(e.key==='Escape'){ hideBlockedPopup(); } };
  document.addEventListener('keydown', escHandler, { once:true });
}
function hideBlockedPopup(){
  const overlay = document.getElementById('blockedPopup');
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
}

/* ===== Login flows ===== */
function finishLogin(userLike){
  const email = userLike.email;
  const name  = userLike.displayName || email.split('@')[0];
  const photo = userLike.photoURL || "";
  const emailKey = sanitizeKey(email);

  db.ref("logins/blocked_users/" + emailKey).once("value").then(snap=>{
    const isBlocked = snap.val();
    if (isBlocked === true){
      showBlockedPopup(userLike);
      auth.signOut().catch(()=>{});
      setLoading(false);
      return;
    }

    db.ref("logins/" + emailKey).set({
      name, email, loginAt: formatTimestamp(new Date())
    }).then(()=>{
      localStorage.setItem("gmailLogin", JSON.stringify({ name, email, photo }));
      const q = new URLSearchParams({ name, email, photo }).toString();
      window.location.href = `${MAIN_URL}/?${q}`;
    }).catch(err=>{
      console.error("❌ Gagal simpan ke Firebase:", err);
      alert("Gagal simpan data login. Coba lagi.");
      setLoading(false);
    });
  });
}

function setLoading(state, which='both'){
  const btnG = document.getElementById('googleLoginBtn');
  const btnU = document.getElementById('btnUserpass');
  if (which==='google' || which==='both'){
    if (btnG){ btnG.disabled = !!state; btnG.textContent = state ? "Logging in..." : "Login with Google"; }
  }
  if (which==='userpass' || which==='both'){
    if (btnU){ btnU.disabled = !!state; btnU.textContent = state ? "Logging in..." : "Login"; }
  }
}

function signInWithGoogle(){
  setLoading(true,'google');
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(res=>{
      const user = res.user;
      if (!user){ throw new Error("User not found"); }
      finishLogin(user);
    })
    .catch(err=>{
      console.error("❌ Login Google gagal:", err);
      alert("Login Google gagal. Coba lagi.");
      setLoading(false,'google');
    });
}

function loginWithUsername(){
  const uname = String(document.getElementById('username').value || '').trim();
  const pass  = String(document.getElementById('password').value || '');
  if (!uname || !pass){ alert("Masukkan username dan password."); return; }
  const email = toPseudoEmail(uname);

  setLoading(true,'userpass');
  auth.signInWithEmailAndPassword(email, pass)
    .then(()=> finishLogin({ email, displayName: uname, photoURL: "" }))
    .catch(async err=>{
      console.warn("Sign-in gagal:", err?.code, err?.message);
      if (err?.code === 'auth/user-not-found'){
        alert("Akaun tidak wujud. Sila hubungi admin untuk buat akaun.");
      } else if (err?.code === 'auth/wrong-password'){
        alert("Password salah.");
      } else if (err?.code === 'auth/too-many-requests'){
        alert("Terlalu banyak cubaan. Cuba lagi kemudian.");
      } else {
        alert("Login gagal. Coba lagi.");
      }
      setLoading(false,'userpass');
    });
}

// Optional createAccount (tetap sama)
async function createAccount(){
  const uname = String(document.getElementById('username').value || '').trim();
  const pass  = String(document.getElementById('password').value || '');
  if (!uname || !pass){ alert("Masukkan username & password."); return; }
  const email = toPseudoEmail(uname);
  try{
    setLoading(true,'userpass');
    await auth.createUserWithEmailAndPassword(email, pass);
    finishLogin({ email, displayName: uname, photoURL:"" });
  }catch(e){
    console.error("Create user gagal:", e);
    alert(e?.message || "Gagal membuat akaun.");
    setLoading(false,'userpass');
  }
}

/* ===== Password eye ===== */
const EYE_SHOW = "M15 12c0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3 3 1.346 3 3zm9-.449s-4.252 8.449-11.985 8.449c-7.18 0-12.015-8.449-12.015-8.449s4.446-7.551 12.015-7.551c7.694 0 11.985 7.551 11.985 7.551zm-7 .449c0-2.757-2.243-5-5-5s-5 2.243-5 5 2.243 5 5 5 5-2.243 5-5z";
const EYE_HIDE = "M11.885 14.988l3.104-3.098.011.11c0 1.654-1.346 3-3 3l-.115-.012zm8.048-8.032l-3.274 3.268c.212.554.341 1.149.341 1.776 0 2.757-2.243 5-5 5-.631 0-1.229-.13-1.785-.344l-2.377 2.372c1.276.588 2.671.972 4.177.972 7.733 0 11.985-8.449 11.985-8.449s-1.415-2.478-4.067-4.595zm1.431-3.536l-18.619 18.58-1.382-1.422 3.455-3.447c-3.022-2.45-4.818-5.58-4.818-5.58s4.446-7.551 12.015-7.551c1.825 0 3.456.426 4.886 1.075l3.081-3.075 1.382 1.42zm-13.751 10.922l1.519-1.515c-.077-.264-.132-.538-.132-.827 0-1.654 1.346-3 3-3 .291 0 .567.055 .833.134l1.518-1.515c-.704-.382-1.496-.619-2.351-.619-2.757 0-5 2.243-5 5 0 .852.235 1.641.613 2.342z";

function togglePassword(){
  const input = document.getElementById('password');
  const btn   = document.getElementById('eyeBtn');
  const path  = document.getElementById('eyePath');
  const isHidden = btn.dataset.state !== 'show';
  if (isHidden){
    input.type = 'text'; btn.dataset.state = 'show';
    btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-label','Hide password');
    path.setAttribute('d', EYE_HIDE);
  } else {
    input.type = 'password'; btn.dataset.state = 'hide';
    btn.setAttribute('aria-pressed','false'); btn.setAttribute('aria-label','Show password');
    path.setAttribute('d', EYE_SHOW);
  }
}
(function addHoldToPeek(){
  const input = document.getElementById('password');
  const btn   = document.getElementById('eyeBtn');
  let holding = false;
  btn.addEventListener('mousedown', ()=>{ holding=true; input.type='text'; });
  btn.addEventListener('mouseup',   ()=>{ if(holding){ holding=false; if(btn.dataset.state!=='show') input.type='password'; }});
  btn.addEventListener('mouseleave',()=>{ if(holding){ holding=false; if(btn.dataset.state!=='show') input.type='password'; }});
  btn.addEventListener('touchstart', ()=>{ input.type='text'; }, {passive:true});
  btn.addEventListener('touchend',   ()=>{ if(btn.dataset.state!=='show') input.type='password'; });
})();

/* ===== Misc ===== */
(function preventDoubleSubmit(){
  const form = document.getElementById('form-userpass');
  if (!form) return;
  let busy = false;
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (busy) return;
    busy = true;
    try { await loginWithUsername(); } finally { busy = false; }
  });
})();
const tabUser = document.getElementById('tab-userpass');
const tabGoo  = document.getElementById('tab-google');
const formUser= document.getElementById('form-userpass');
const formGoo = document.getElementById('form-google');
tabUser?.addEventListener('click', ()=>{ tabUser.classList.add('active'); tabGoo.classList.remove('active'); formUser.classList.add('active'); formGoo.classList.remove('active'); });
tabGoo?.addEventListener('click', ()=>{ tabGoo.classList.add('active'); tabUser.classList.remove('active'); formGoo.classList.add('active'); formUser.classList.remove('active'); });

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("googleLoginBtn")?.addEventListener("click", signInWithGoogle);
  document.getElementById('eyeBtn')?.addEventListener('click', togglePassword);
});
  // ====== CONFIG ======
  const LC_URL = "https://searcfile.github.io/5g88-php/userlivechatphp/";   // URL app livechat kamu
  const LC_ORIGIN = new URL(LC_URL).origin;

  // ====== Elemen ======
  const lcToggle = document.getElementById("lcToggle");
  const lcPanel  = document.getElementById("lcPanel");
  const lcFrame  = document.getElementById("lcFrame");
  const lcDot    = document.getElementById("lcDot");
  let lcLoaded = false;

  // ====== Ambil identitas user utk pre-chat ======
  function getPrechatUser(){
    // 1) kalau sudah login (gmailLogin ada), pakai itu
    try {
      const gl = JSON.parse(localStorage.getItem("gmailLogin") || "{}");
      if (gl?.email) return { name: gl.name || gl.email, email: gl.email, photo: gl.photo || "" };
    } catch {}

    // 2) belum login → ambil dari input username form login (kalau ada)
    const unameEl = document.getElementById("username");
    const uname = (unameEl?.value || "").trim();
    if (uname) return { name: uname, email: (uname + "@5g88.local").toLowerCase(), photo: "" };

    // 3) fallback guest
    return { name: "Guest", email: "guest@5g88.local", photo: "" };
  }

  function postIdentityToChat(){
    if (!lcFrame?.contentWindow) return;
    const u = getPrechatUser();
    lcFrame.contentWindow.postMessage({ type: "user-login", user: u }, LC_ORIGIN);
  }

  // ====== Toggle panel open/close ======
  lcToggle.addEventListener("click", () => {
    const open = !lcPanel.classList.contains("active");
    if (open){
      lcPanel.classList.add("active");
      lcPanel.setAttribute("aria-hidden","false");

      if (!lcLoaded){
        lcFrame.src = LC_URL;  // load iframe ketika pertama dibuka
        lcFrame.addEventListener("load", () => {
          lcLoaded = true;
          postIdentityToChat();   // kirim identitas setelah iframe siap
        }, { once:true });
      } else {
        postIdentityToChat();     // update identitas kalau user ganti username
      }
      lcDot.style.display = "none";  // anggap terbaca
    } else {
      lcPanel.classList.remove("active");
      lcPanel.setAttribute("aria-hidden","true");
    }
  });

  // Update identitas jika user mengisi username lalu keluar dari input
  document.getElementById("username")?.addEventListener("blur", () => {
    if (lcPanel.classList.contains("active")) postIdentityToChat();
  });

  // ====== Notifikasi dari iframe -> tampilkan dot merah ======
  window.addEventListener("message", (e) => {
    if (e.origin !== LC_ORIGIN) return;
    const data = e.data || {};
    if (data.action === "show-livechat-notif") {
      lcDot.style.display = "inline-block";
    } else if (data.action === "hide-livechat-notif") {
      lcDot.style.display = "none";
    }
  });
</script>
</body>
</html>
