<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #000;
    color: #3b8cff;
    padding: 0; margin: 0;
    overflow-y: scroll; overflow-x: hidden;
    -ms-overflow-style: none; scrollbar-width: none;
  }
  html,body { overflow-y: scroll; -ms-overflow-style: none; scrollbar-width: none; }
  html::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }
  html { overflow-x: hidden; }
  *, *::before, *::after { box-sizing: border-box; }

  .header{
    background-color: #1668dc; font-size: 30px; height: 90px;
    display: flex; justify-content: center; align-items: center;
    color: #fff; font-weight: bold;
  }
  .table-container{ padding: 0 20px; }

  .search-container{
    display: flex; align-items: center; justify-content: flex-start;
    max-width: 100%; padding: 0 20px; margin: 20px 0 10px;
    background: transparent; gap: 8px; box-sizing: border-box; flex-wrap: wrap;
  }
  .search-box{ display:flex; min-width:260px; width:auto; flex:0 1 500px; }
  /* INPUT */
  .search-container input{
    flex:1; padding:10px 10px; font-size:14px; color:#fff;
    background:#141414; border:1px solid #424242; border-radius:6px 0 0 6px; outline:none; transition:.2s;
  }
  .search-container input::placeholder{ color:rgba(255,255,255,.4); }
  .search-container input:hover{ border-color:#3b8cff; }
  .search-container input:focus{ border-color:#1668dc; }

  /* BUTTON Search */
  .search-container button{
    padding:10px 10px; background:#141414; border:1px solid #424242; border-left:1px solid #424242;
    border-radius:0 6px 6px 0; display:flex; align-items:center; justify-content:center;
    cursor:pointer; color:#aaa; transition:.2s;
  }
  .search-container button:hover{ border-color:#3b8cff; color:#3b8cff; background:#1a1a1a; }
  .search-container button:active{ border-color:#1668dc; color:#1668dc; background:#1a1a1a; }
  .search-container button svg{ stroke:currentColor; transition:stroke .2s; }
  #searchBtn.loading{
    border:1px solid #3b8cff; border-radius:0 6px 6px 0; box-shadow:0 0 10px #3b8cff; background:#1a1a1a;
  }
  #searchBtn.loading svg{ stroke:#3b8cff; filter:drop-shadow(0 0 5px #3b8cff); animation:pulseIcon 5s ease-in-out infinite; }
  @keyframes pulseIcon{ 0%{filter:drop-shadow(0 0 0 #3b8cff)}50%{filter:drop-shadow(0 0 8px #3b8cff)}100%{filter:drop-shadow(0 0 0 #3b8cff)} }
  
  #forceLogoutAllBtn{
  margin-left:auto;   /* ✅ tombol ini saja yang ke kanan */
}
  /* DROPDOWN Status Filter */
  .status-filter{
    padding:10px; font-size:14px; color:#1668dc; background:#141414;
    border:1px solid #424242; border-radius:6px; outline:none; transition:.2s;height:38px;
  }
  .status-filter:hover{ border-color:#3b8cff; }
  .status-filter:focus{ border-color:#1668dc; }

  /* Force Logout All */
  #forceLogoutAllBtn{
    background:#dc2626; color:#fff; padding:10px 16px; border:none; border-radius:6px; cursor:pointer; white-space:nowrap; transition:.2s;
  }
  #forceLogoutAllBtn:hover{ background:#e75858; color:#fff; }
  #forceLogoutAllBtn:active{ background:#b31616; color:#fff; }

  /* Confirm popover */
  .confirm-box{
    background:#1f1f1f; border:1px solid #3b8cff; border-radius:6px; padding:10px; width:180px;
    box-shadow:0 4px 10px rgba(0,0,0,.4); color:#fff; font-size:12px; line-height:1.3; word-wrap:break-word;
    white-space:normal; opacity:0; transition:opacity .2s ease;
  }
  .confirm-box.show{ opacity:1; }
  .confirm-message{ margin-bottom:8px; }
  .confirm-user-info{ margin-bottom:8px; font-size:11px; line-height:1.2; color:#ccc; }
  .confirm-actions{ display:flex; justify-content:flex-start; gap:6px; flex-wrap:wrap; }
  .user-line{ background:#2c1618; border:1px solid #5b2526; padding:4px 6px; border-radius:4px; margin-bottom:3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .btn-no,.btn-yes{ padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer; border:none; }
  .btn-no{ background:#3a3a3a; color:#fff; }
  .btn-yes{ background:#dc2626; color:#fff; }
  .btn-no:hover,.btn-yes:hover{ opacity:.9; }
  @media (max-width:480px){
    .confirm-box{ width:95vw!important; max-width:95vw; left:10px!important; right:10px!important; }
  }

  /* Toast */
  .toast{
    position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px);
    background:#1e293b; color:#cbd5e1; padding:12px 20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.35);
    font-size:14px; z-index:99999; opacity:0; display:flex; align-items:center; gap:10px; min-width:280px; max-width:90%;
    transition:transform .4s ease, opacity .4s ease;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); pointer-events:auto; }
  .toast .close-btn{ background:transparent; border:none; color:#888; font-size:18px; cursor:pointer; margin-left:auto; }
  .toast .close-btn:hover{ color:#fff; }
  .toast.success .toast-icon{ color:#22c55e; font-size:14px;}
  .toast.error .toast-icon{ color:#ef4444; font-size:14px;}
  .toast-icon{ flex-shrink:0; display:inline-block; vertical-align:middle; width:20px; height:20px;}

  /* Buttons in table */
  .action-buttons{ display:inline-flex; align-items:center; gap:6px; white-space:nowrap; }
  .logout-btn{
    background:#dc2626; color:#fff; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; transition:background .2s; min-width:0 !important;
  }
  .logout-btn:hover{ background:#e75858; color:#fff; }
  .logout-btn:active{ background:#b31616; color:#fff; }
  .block-btn{
    background:#facc15; color:#000; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; transition:all .2s; min-width:0 !important;
  }
  .block-btn:hover{ background:#fcd34d; }
  .block-btn:active{ background:#a5882b; }
  .block-btn.blocked{ color:red; background:#facc15; }
  .block-btn.blocked:hover{ color:#000; background:#fcd34d; }
  .block-btn.blocked:active{ background:#a5882b; color:#000; }

  /* Viewport & table */
  .table-viewport{
    --row-h:48px; --head-h:52px;
    max-height: calc(var(--head-h) + var(--row-h) * 15);
    overflow:auto; overflow-x:auto; -webkit-overflow-scrolling:touch;
    border:1px solid #3b8cff; border-radius:8px; background:#0b0b0b;
    scrollbar-width:thin; scrollbar-color:#1668dc transparent;
  }
  .table-viewport::-webkit-scrollbar{ width:10px; height:10px; }
  .table-viewport::-webkit-scrollbar-track{ background:#0f172a; border-radius:8px; box-shadow:inset 0 0 0 1px #1f2937; }
  .table-viewport::-webkit-scrollbar-thumb{ background:#6b7280; border-radius:8px; border:2px solid #0f172a; }
  .table-viewport::-webkit-scrollbar-thumb:hover{ background:#3c89e8; }
  .table-viewport::-webkit-scrollbar-corner{ background:#0f172a; }
  .table-viewport::-webkit-scrollbar-button{ height:10px; width:10px; background:#0f172a; }

  .tbl{ width:100%; border-collapse:collapse; table-layout:fixed; }
  .tbl th,.tbl td{ padding:8px 12px; border-bottom:1px solid #1f2937; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tbl thead th{ position:sticky; top:0; z-index:2; background:#1668dc; color:#fff; text-align:left; }

  /* OVERRIDES: single line, horizontal scroll */
  .table-viewport{ overflow-x:auto !important; }
  .tbl{ table-layout:auto !important; width:max-content !important; min-width:100% !important; }
  .tbl th,.tbl td{ white-space:nowrap !important; overflow:visible !important; text-overflow:initial !important; }

  /* Column widths (updated indices) */
  .tbl th:nth-child(1), .tbl td:nth-child(1){ width:56px !important; text-align:center; }       /* No */
  .tbl th:nth-child(6), .tbl td:nth-child(6){ width:170px !important; }                          /* Action (now col 6) */
  .tbl th:nth-child(5), .tbl td:nth-child(5){ width:140px !important; }                          /* Active/Unactive */

  /* Status badge layout */
  .status-cell{ display:flex; align-items:center; gap:8px; }
  .status-text{ color:#cbd5e1; font-size:13px; }

  /* Mobile tweaks */
  @media (max-width:640px){
    .search-container{ gap:8px; justify-content:flex-start; }
    .search-box{ width:auto; flex:1 1 auto; min-width:0; }
    .status-filter{ flex:0 0 auto; }
    #forceLogoutAllBtn{ flex:0 0 auto; margin-left:auto; margin-top:4px; }
    .tbl th:nth-child(1), .tbl td:nth-child(1){ width:46px !important; }
    .tbl th:nth-child(6), .tbl td:nth-child(6){ width:140px !important; }
    .logout-btn, .block-btn{ padding:6px 10px; }
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="header">User List (Login)</div>

  <div class="search-container">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search" autocomplete="off" />
      <button id="searchBtn" type="button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M21 21L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="10" cy="10" r="6" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>

    <!-- ✅ NEW: Status filter -->
    <select id="statusFilter" class="status-filter">
      <option value="All">All</option>
      <option value="Active">Active</option>
      <option value="Unactive">Unactive</option>
    </select>

    <button id="forceLogoutAllBtn">Force Logout All</button>
  </div>

  <div class="table-container">
    <div class="table-viewport" id="tableViewport">
      <table class="tbl" id="loginTable">
        <thead>
          <tr>
            <th>No</th>
            <th>Name</th>
            <th>Email</th>
            <th>Last login</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="loginTableBody">
          <tr><td colspan="6">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Confirm popovers -->
  <div id="confirmAllBox" class="confirm-box" style="display:none; position:absolute; z-index:9999;">
    <div class="confirm-message">Logout all users?</div>
    <div class="confirm-actions">
      <button id="confirmAllNo" class="btn-no">No</button>
      <button id="confirmAllYes" class="btn-yes">Yes</button>
    </div>
  </div>
  <div id="confirmBox" class="confirm-box" style="display:none; position:absolute; z-index:9999;">
    <div class="confirm-message">Logout this user?</div>
    <div class="confirm-user-info">
      <div id="confirmUserName" class="user-line"></div>
      <div id="confirmUserEmail" class="user-line"></div>
    </div>
    <div class="confirm-actions">
      <button id="confirmNo" class="btn-no">No</button>
      <button id="confirmYes" class="btn-yes">Yes</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <span class="toast-icon"></span>
    <span class="toast-message" id="toast-message"></span>
    <button type="button" class="close-btn" onclick="hideToast()">✖</button>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCZ9zUxDf3V9TvI3vOdgeZD7pLE4IuPrOE",
    authDomain: "logins-d615f.firebaseapp.com",
    databaseURL: "https://logins-d615f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "logins-d615f",
    storageBucket: "logins-d615f.appspot.com",
    messagingSenderId: "580872784703",
    appId: "1:580872784703:web:07957551c3214f3d32618a"
  };
  firebase.initializeApp(firebaseConfig);

  const dbRef       = firebase.database().ref('logins');
  const blockedRef  = firebase.database().ref('logins/blocked_users');

  // ---------- Utils ----------
  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }
  function sanitizeEmail(email){
    if (!email || typeof email !== 'string') return '';
    return email.replace(/\./g, "_").replace(/[#$\[\]]/g, '');
  }
  function parseDateString(dateString){
    if (!dateString) return null;
    const cleaned = dateString.replace(/\s*-\s*/g, '-').trim();
    const parts = cleaned.split(' ');
    if (parts.length < 2) return null;
    const [y,m,d] = parts[0].split('-');
    const iso = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T${parts[1]}`;
    const dt = new Date(iso);
    return isNaN(dt) ? null : dt;
  }
  function formatDateTime(date){
    const dd = String(date.getDate()).padStart(2,'0');
    const mm = String(date.getMonth()+1).padStart(2,'0');
    const yy = date.getFullYear();
    const hh = String(date.getHours()).padStart(2,'0');
    const mi = String(date.getMinutes()).padStart(2,'0');
    const ss = String(date.getSeconds()).padStart(2,'0');
    return `${dd}/${mm}/${yy}, ${hh}:${mi}:${ss}`;
  }

  // Search + Status filter
  function filterByQuery(query, data){
    const q = (query || '').toLowerCase();
    return data.filter(it =>
      (it.name  || '').toLowerCase().includes(q) ||
      (it.email || '').toLowerCase().includes(q)
    );
  }
  function applyFilters(query, status, data){
    let arr = filterByQuery(query, data);
    if (status === 'Active'){
      arr = arr.filter(it => !isEmailBlockedFast(it.email));
    } else if (status === 'Unactive'){
      arr = arr.filter(it => isEmailBlockedFast(it.email));
    }
    return arr;
  }

  // Viewport
  function fitViewportToRows(n = 15){
    const vp  = document.getElementById('tableViewport');
    const tbl = document.getElementById('loginTable');
    if (!vp || !tbl) return;
    const headH = tbl.tHead ? tbl.tHead.offsetHeight : 0;
    const rows  = Array.from(tbl.tBodies[0]?.rows || []).slice(0, n);
    const rowsH = rows.reduce((sum, tr) => sum + tr.getBoundingClientRect().height, 0);
    vp.style.maxHeight = (headH + rowsH) + 'px';
  }

  // ---------- Global state ----------
  let allLoginData = [];
  let currentConfirmEmail = null;
  let isConfirmAllVisible = false;
  let blockedSet = new Set();

  // ---------- Toast ----------
  function showToast(message, type="success", duration=4000){
    const toast = document.getElementById("toast");
    const msgSpan = toast.querySelector(".toast-message");
    const iconSvg = toast.querySelector(".toast-icon");
    toast.classList.remove("success","error");
    toast.classList.add(type);
    msgSpan.textContent = message;
    iconSvg.innerHTML = (type === "success")
      ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-1 17l-5-5.299 1.399-1.43 3.574 3.736 6.572-7.007 1.455 1.403-8 8.597z"/></svg>`
      : `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm5.5 15.1L15.1 17.5 12 14.4 8.9 17.5 6.5 15.1 9.6 12 6.5 8.9 8.9 6.5 12 9.6l3.1-3.1 2.4 2.4L14.4 12l3.1 3.1z"/></svg>`;
    toast.style.display = "flex";
    requestAnimationFrame(()=> toast.classList.add("show"));
    clearTimeout(window.toastTimeout);
    window.toastTimeout = setTimeout(hideToast, duration);
  }
  function hideToast(){
    const toast = document.getElementById("toast");
    toast.classList.remove("show");
    setTimeout(()=> { toast.style.display = "none"; }, 300);
  }

  // ---------- Block cache ----------
  blockedRef.on('value', (snap) => {
    const val = snap.val() || {};
    blockedSet = new Set(
      Object.entries(val).filter(([_,v]) => Boolean(v)).map(([k]) => k)
    );

    // Sinkronkan tombol block dan status cell
    document.querySelectorAll('.block-btn').forEach(btn => {
      const email = btn.dataset.email || '';
      const isBlocked = isEmailBlockedFast(email);
      btn.textContent = isBlocked ? 'Unblock' : 'Block';
      btn.classList.toggle('blocked', isBlocked);
    });

    // Re-render supaya kolom status ikut update
    rerenderWithCurrentFilters();
  });

  function isEmailBlockedFast(email){
    return blockedSet.has(sanitizeEmail(email));
  }

  // ---------- Actions ----------
  function forceLogoutUser(email){
    const key = sanitizeEmail(email);
    const payload = { forceLogout: true, at: Date.now() };
    firebase.database()
      .ref('logins/admin_override/' + key)
      .set(payload)
      .then(()=> showToast(`Logout sent to ${email}`))
      .catch(err=> showToast(`Error logout: ${err.message}`, "error"));
  }

  function toggleBlockUser(button){
    const email = button.getAttribute("data-email");
    const key   = sanitizeEmail(email);
    const newStatus = !isEmailBlockedFast(email);
    blockedRef.child(key).set(newStatus)
      .then(()=> showToast(`${newStatus ? "Blocked" : "Unblocked"}: ${email}`, "success"))
      .catch(err=> showToast(`Failed: ${err.message}`, "error"));
  }

  // ---------- Render table (UPDATED) ----------
  function statusCellHtml(isActive){
    if (isActive){
      return `
        <div class="status-cell" title="Active">
          <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="9" fill="#00ff00"></circle>
          </svg>
          <span class="status-text">Active</span>
        </div>`;
    } else {
      return `
        <div class="status-cell" title="Unactive">
          <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="9" fill="red"></circle>
            <path d="M8 8 L16 16 M16 8 L8 16" stroke="#111" stroke-width="2" stroke-linecap="round"></path>
          </svg>
          <span class="status-text">Unactive</span>
        </div>`;
    }
  }

  function renderLoginTable(dataArray){
    const tbody = document.getElementById('loginTableBody');

    if (!dataArray.length){
      tbody.innerHTML = '<tr><td colspan="6">No matching login data found.</td></tr>';
      requestAnimationFrame(()=> fitViewportToRows(1));
      return;
    }

    let html = '';
    let no = 0;

    dataArray.forEach(item => {
      const email = item.email || '';
      const name  = item.name  || '';
      const tStr  = item.dateObj ? formatDateTime(item.dateObj) : (item.loginRaw || '');
      if (!email && !name && !tStr) return;

      no++;
      const active = !isEmailBlockedFast(email);

      html += `
        <tr data-email="${esc(email)}">
          <td>${no}</td>
          <td title="${esc(name)}">${esc(name || '-')}</td>
          <td title="${esc(email)}">${esc(email)}</td>
          <td title="${esc(tStr)}">${esc(tStr)}</td>
          <td>${statusCellHtml(active)}</td>
          <td>
            <div class="action-buttons">
              <button class="logout-btn"
                      data-email="${esc(email)}"
                      data-name="${esc(name || '-')}"
                      onclick="showConfirmBox(this, this.dataset.email, this.dataset.name)">
                Logout
              </button>
              <button class="block-btn"
                      data-email="${esc(email)}"
                      onclick="toggleBlockUser(this)">
                ${active ? 'Block' : 'Unblock'}
              </button>
            </div>
          </td>
        </tr>`;
    });

    tbody.innerHTML = html;

    // Set tampilan tombol block dari cache
    tbody.querySelectorAll('.block-btn').forEach(btn => {
      const email = btn.dataset.email || '';
      const blocked = isEmailBlockedFast(email);
      btn.textContent = blocked ? "Unblock" : "Block";
      btn.classList.toggle("blocked", blocked);
    });

    requestAnimationFrame(()=> fitViewportToRows(15));
  }

  // ---------- Realtime data ----------
  function startRealtime(){
    const searchBtn = document.getElementById('searchBtn');
    searchBtn.classList.add('loading');

    dbRef.on('value', (snapshot) => {
      const data = snapshot.val() || {};
      allLoginData = Object.entries(data)
        .filter(([k]) => k !== "blocked_users" && k !== "admin_override")
        .map(([_, item]) => {
          const dateObj = parseDateString(item.loginAt);
          return { ...item, dateObj, loginRaw: item.loginAt || '-' };
        })
        .filter(it => it.email || it.name || it.loginRaw)
        .sort((a,b) => {
          if (!a.dateObj && !b.dateObj) return 0;
          if (!a.dateObj) return 1;
          if (!b.dateObj) return -1;
          return b.dateObj - a.dateObj;
        });

      rerenderWithCurrentFilters();
      searchBtn.classList.remove('loading');
    }, (error) => {
      document.getElementById('loginTableBody').innerHTML =
        `<tr><td colspan="6">Error: ${error.message}</td></tr>`;
      searchBtn.classList.remove('loading');
    });
  }

  // ---------- Search & Filter listeners ----------
  function currentStatusValue(){
    return document.getElementById('statusFilter')?.value || 'All';
  }
  function currentQueryValue(){
    return document.getElementById('searchInput')?.value || '';
  }
  function rerenderWithCurrentFilters(){
    const q = currentQueryValue();
    const s = currentStatusValue();
    renderLoginTable(applyFilters(q, s, allLoginData));
  }

  function setupSearchListener(){
    const input = document.getElementById('searchInput');
    const select = document.getElementById('statusFilter');

    if (input){
      input.addEventListener('input', () => rerenderWithCurrentFilters());
    }
    if (select){
      select.addEventListener('change', () => rerenderWithCurrentFilters());
    }
    document.getElementById('searchBtn').addEventListener('click', () => {
      rerenderWithCurrentFilters();
    });
  }

  // ---------- Confirm popovers ----------
  function showConfirmAllBox(button){
    const box = document.getElementById("confirmAllBox");
    if (isConfirmAllVisible){
      box.style.display = "none";
      box.classList.remove("show");
      isConfirmAllVisible = false;
      return;
    }
    const yesBtn = document.getElementById("confirmAllYes");
    const noBtn  = document.getElementById("confirmAllNo");

    box.style.display = "block";
    box.classList.add("show");
    isConfirmAllVisible = true;

    const rect = button.getBoundingClientRect();
    const bw   = box.offsetWidth;
    let left   = rect.left + (rect.width/2) - (bw/2);
    const maxL = window.innerWidth - bw - 10;
    if (left > maxL) left = maxL;
    if (left < 10)  left = 10;

    box.style.top  = `${rect.bottom + window.scrollY + 6}px`;
    box.style.left = `${left}px`;

    yesBtn.replaceWith(yesBtn.cloneNode(true));
    noBtn.replaceWith(noBtn.cloneNode(true));

    document.getElementById("confirmAllYes").onclick = () => {
      box.style.display = "none";
      box.classList.remove("show");
      isConfirmAllVisible = false;
      doForceLogoutAll();
    };
    document.getElementById("confirmAllNo").onclick = () => {
      box.style.display = "none";
      box.classList.remove("show");
      isConfirmAllVisible = false;
    };
  }

  function showConfirmBox(button, email, name='-'){
    const box = document.getElementById("confirmBox");
    if (box.style.display === "block" && currentConfirmEmail === email){
      box.style.display = "none";
      box.classList.remove("show");
      currentConfirmEmail = null;
      return;
    }
    const yesBtn = document.getElementById("confirmYes");
    const noBtn  = document.getElementById("confirmNo");

    currentConfirmEmail = email;
    document.getElementById("confirmUserName").textContent  = name || '-';
    document.getElementById("confirmUserEmail").textContent = email;

    box.style.display = "block";
    box.classList.add("show");

    const rect = button.getBoundingClientRect();
    const bw   = box.offsetWidth;
    let left   = rect.left + (rect.width/2) - (bw/2);
    const maxL = window.innerWidth - bw - 10;
    if (left > maxL) left = maxL;
    if (left < 10)  left = 10;

    box.style.top  = `${rect.bottom + window.scrollY + 6}px`;
    box.style.left = `${left}px`;

    yesBtn.replaceWith(yesBtn.cloneNode(true));
    noBtn.replaceWith(noBtn.cloneNode(true));

    document.getElementById("confirmYes").onclick = () => {
      box.style.display = "none";
      box.classList.remove("show");
      currentConfirmEmail = null;
      forceLogoutUser(email);
    };
    document.getElementById("confirmNo").onclick = () => {
      box.style.display = "none";
      box.classList.remove("show");
      currentConfirmEmail = null;
    };
  }
  document.getElementById('forceLogoutAllBtn')
    .addEventListener('click', function(){ showConfirmAllBox(this); });

  function doForceLogoutAll(){
    const ts = Date.now();
    const emails = allLoginData.filter(u => u.email).map(u => u.email);
    if (emails.length === 0) return showToast('Tidak ada user untuk di-logout.', 'error');

    const updates = {};
    emails.forEach(email => {
      const key = sanitizeEmail(email);
      updates['logins/admin_override/' + key] = { forceLogout: true, at: ts };
    });

    firebase.database().ref().update(updates)
      .then(() => {
        let delay = 0;
        emails.forEach(email => {
          setTimeout(() => showToast(`Logout sent to ${email}`), delay);
          delay += 200;
        });
      })
      .catch(err => showToast(`Error force logout all: ${err.message}`, "error"));
  }

  // --------- Startup ----------
  function init(){
    startRealtime();
    setupSearchListener();

    if (window.ResizeObserver){
      const ro = new ResizeObserver(() => fitViewportToRows(15));
      const tbody = document.getElementById('loginTableBody');
      if (tbody) ro.observe(tbody);
    } else {
      window.addEventListener('resize', () => fitViewportToRows(15));
    }
  }
  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
