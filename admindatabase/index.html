<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin</title>
<style>
  body {
  font-family: Arial, sans-serif;
  background: #000;
  color: #3b8cff;
  padding: 0;
  margin: 0;
  overflow-y: scroll;         
  overflow-x: hidden;        
  -ms-overflow-style: none;  
  scrollbar-width: none;     
}
html,body {
 overflow-y: scroll; 
 -ms-overflow-style: none;  
 scrollbar-width: none; 
}
html::-webkit-scrollbar {
  display: none;    
}
body::-webkit-scrollbar {
  display: none;            
}
html {
  overflow-x: hidden;
}
*, *::before, *::after {
  box-sizing: border-box;
}
  .header {
  background-color: #1668dc;
  font-size: 30px;
  height: 90px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-weight: bold;
}
  .table-container {
  padding: 0 20px;
}
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: transparent;
  }
  th, td {
    border: 1px solid #444;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #1668dc;
    color: #fff;
  }
  tbody tr:nth-child(even) {
    background: #141414;
  }
 .search-container {
  display: flex;
  align-items: center;
  justify-content: space-between; /* ✅ */
  max-width: 100%;
  padding: 0 20px;
  margin: 20px 0 10px;
  background-color: transparent;
  gap: 10px;
  box-sizing: border-box;
}
.search-box {
  display: flex;
  width: 500px;
}
/* INPUT */
.search-container input {
  flex: 1;
  padding: 10px 10px;
  font-size: 14px;
  color: white;
  background-color: #141414;
  border: 1px solid #424242;
  border-radius: 6px 0 0 6px;
  outline: none;
  box-sizing: border-box;
  transition: border-color 0.2s;
}

.search-container input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.search-container input:hover {
  border-color: #3b8cff;
}
.search-container input:focus {
  border-color: #1668dc;
}

/* BUTTON */
.search-container button {
  padding: 10px 10px;
  background-color: #141414;
  border: 1px solid #424242;
  border-left: 1px solid #424242; /* penting agar tak dobel border */
  border-radius: 0 6px 6px 0;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #aaa;
  transition: color 0.2s, background-color 0.2s, border-color 0.2s;
  box-sizing: border-box;
}

.search-container button:hover {
  border-color: #3b8cff;
  color: #3b8cff;
  background-color: #1a1a1a;
}
.search-container button:active {
  border-color: #1668dc;
  color: #1668dc;
  background-color: #1a1a1a;
}

/* SVG ikut warna */
.search-container button svg {
  stroke: currentColor;
  transition: stroke 0.2s;
}
#searchBtn.loading {
  border: 1px solid #3b8cff;
  border-radius: 0 6px 6px 0;
  box-shadow: 0 0 10px #3b8cff;
  background-color: #1a1a1a;
}

#searchBtn.loading svg {
  stroke: #3b8cff;
  filter: drop-shadow(0 0 5px #3b8cff);
  animation: pulseIcon 5s ease-in-out infinite;
}

@keyframes pulseIcon {
  0% { filter: drop-shadow(0 0 0px #3b8cff); }
  50% { filter: drop-shadow(0 0 8px #3b8cff); }
  100% { filter: drop-shadow(0 0 0px #3b8cff); }
}
#forceLogoutAllBtn {
  background: #dc2626;
  color: white;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap;
}
#forceLogoutAllBtn:hover {
 background: #e75858;
 color: white;
}
#forceLogoutAllBtn:active {
 background: #b31616;
 color: white;
}
.confirm-box {
  background-color: #1f1f1f;
  border: 1px solid #3b8cff;
  border-radius: 6px;
  padding: 10px;
  width: 180px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  color: white;
  font-size: 12px;
  line-height: 1.3;
  word-wrap: break-word;
  white-space: normal;
}

.confirm-message {
  margin-bottom: 8px;
}

.confirm-actions {
  display: flex;
  justify-content: flex-start; /* ✅ tombol di kiri */
  gap: 6px;
  flex-wrap: wrap;
}

.btn-no,
.btn-yes {
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  border: none;
}

.btn-no {
  background-color: #3a3a3a;
  color: white;
}

.btn-yes {
  background-color: #dc2626;
  color: white;
}

.btn-no:hover,
.btn-yes:hover {
  opacity: 0.9;
}
.confirm-user-info {
  margin-bottom: 8px;
  font-size: 11px;
  line-height: 1.2;
  color: #ccc;
}
.confirm-box {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.confirm-box.show {
  opacity: 1;
}
.user-line {
  background: #2c1618;
  border: 1px solid #5b2526;
  padding: 4px 6px;
  border-radius: 4px;
  margin-bottom: 3px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
  @media (max-width: 480px) {
  .confirm-box {
    width: 95vw !important;
    max-width: 95vw;
    left: 10px !important;
    right: 10px !important;
  }
}
.logout-btn {
  background: #dc2626;
  color: white;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}
.logout-btn:hover {
  background: #e75858;
  color: white;
}

.logout-btn:active {
  background: #b31616;
  color: white;
}
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: #1e293b;
  color: #cbd5e1;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
  font-size: 14px;
  z-index: 99999;
  opacity: 0;
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 280px;
  max-width: 90%;
  transition: transform 0.4s ease, opacity 0.4s ease;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}
.toast .close-btn {
  background: transparent;
  border: none;
  color: #888;
  font-size: 18px;
  cursor: pointer;
  margin-left: auto;
}
.toast .close-btn:hover {
  color: #fff;
}
.toast.success .toast-icon {
  color: #22c55e; /* hijau */
  font-size: 14px;
}
.toast.error .toast-icon {
  color: #ef4444; /* merah */
  font-size: 14px;
}
.toast-icon {
  flex-shrink: 0;
  display: inline-block;
  vertical-align: middle;
  width: 20px;
  height: 20px;
}
.block-btn {
  background: #facc15;
  color: black;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 5px;
  transition: background 0.2s;
}
.block-btn:hover {
  background: #fcd34d;
}
.block-btn.blocked {
  background: #9ca3af; /* abu abu */
  color: white;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
<div class="header">User List (Login)</div>
  
<div class="search-container">
  <div class="search-box">
    <input
      type="text"
      id="searchInput"
      placeholder="Search"
      autocomplete="off"
    />
    <button id="searchBtn" type="button">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M21 21L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="10" cy="10" r="6" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>
  </div>
  <button id="forceLogoutAllBtn">Force Logout All</button>
</div>
  
<div class="table-container">
<table>
  <thead>
    <tr>
      <th>No</th>
      <th>Name</th>
      <th>Email</th>
      <th>Time Logged In</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="loginTableBody">
    <tr><td colspan="4">Loading data...</td></tr>
  </tbody>
</table>
</div>
  
<div id="confirmAllBox" class="confirm-box" style="display: none; position: absolute; z-index: 9999;">
  <div class="confirm-message">Logout all users?</div>
  <div class="confirm-actions">
    <button id="confirmAllNo" class="btn-no">No</button>
    <button id="confirmAllYes" class="btn-yes">Yes</button>
  </div>
</div>
  
<div id="confirmBox" class="confirm-box" style="display: none; position: absolute; z-index: 9999;">
  <div class="confirm-message">Logout this user?</div>
  <div class="confirm-user-info">
    <div id="confirmUserName" class="user-line"></div>
    <div id="confirmUserEmail" class="user-line"></div>
  </div>
  <div class="confirm-actions">
    <button id="confirmNo" class="btn-no">No</button>
    <button id="confirmYes" class="btn-yes">Yes</button>
  </div>
</div>
<div id="toast" class="toast">
  <span class="toast-icon"></span>
  <span class="toast-message" id="toast-message"></span>
  <button type="button" class="close-btn" onclick="hideToast()">✖</button>
</div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCZ9zUxDf3V9TvI3vOdgeZD7pLE4IuPrOE",
    authDomain: "logins-d615f.firebaseapp.com",
    databaseURL: "https://logins-d615f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "logins-d615f",
    storageBucket: "logins-d615f.appspot.com",
    messagingSenderId: "580872784703",
    appId: "1:580872784703:web:07957551c3214f3d32618a"
  };

  firebase.initializeApp(firebaseConfig);
  const dbRef = firebase.database().ref('logins');

  const blockedRef = firebase.database().ref('logins/blocked_users');


function sanitizeEmail(email) {
  return email.replace(/\./g, "_");
}

function isEmailBlocked(email) {
  const key = sanitizeEmail(email);
  return blockedRef.child(key).once('value').then(snapshot => !!snapshot.val());
}

function setEmailBlocked(email, isBlocked) {
  const key = sanitizeEmail(email);
  return blockedRef.child(key).set(isBlocked);
}

  let allLoginData = [];
  let currentConfirmEmail = null;
  let isConfirmAllVisible = false;

  function parseDateString(dateString) {
    if (!dateString) return null;
    const cleaned = dateString.replace(/\s*-\s*/g, '-').trim();
    const parts = cleaned.split(' ');
    if (parts.length < 2) return null;

    const datePart = parts[0];
    const timePart = parts[1];
    const [year, month, day] = datePart.split('-');

    const isoString = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}`;
    const date = new Date(isoString);
    return isNaN(date) ? null : date;
  }

  function formatDateTime(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
  }

  function filterTable(query, data) {
    const lowerQuery = query.toLowerCase();
    return data.filter(item =>
      (item.name || '').toLowerCase().includes(lowerQuery) ||
      (item.email || '').toLowerCase().includes(lowerQuery)
    );
  }
function forceLogoutUser(email) {
  const userId = email.replace(/\./g, "_");
  firebase.database().ref("logins/admin_override").set({
    target: userId,
    forceLogout: true,
    time: Date.now()
  }).then(() => {
    showToast(`Logout Successfuly ${email}`);
  }).catch(err => {
    showToast(`Error logout: ${err.message}`, "error");
  });
}
function showToast(message, type = "success", duration = 4000) {
  const toast = document.getElementById("toast");
  const msgSpan = toast.querySelector(".toast-message");
  const iconSvg = toast.querySelector(".toast-icon");

  // Reset kelas
  toast.classList.remove("success", "error");
  toast.classList.add(type);

  msgSpan.textContent = message;

  // Tukar ikon SVG berdasarkan tipe
  if (type === "success") {
    iconSvg.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12
                 12-5.373 12-12-5.373-12-12-12zm-1 17l-5-5.299
                 1.399-1.43 3.574 3.736 6.572-7.007 
                 1.455 1.403-8 8.597z" /></svg>`;
  } else if (type === "error") {
    iconSvg.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 
                 12-5.4 12-12S18.6 0 12 0zm5.5 15.1L15.1 17.5 
                 12 14.4 8.9 17.5 6.5 15.1 9.6 12 6.5 8.9 
                 8.9 6.5 12 9.6l3.1-3.1 2.4 2.4L14.4 12l3.1 3.1z"/></svg>`;
  }

  toast.style.display = "flex";
  requestAnimationFrame(() => {
    toast.classList.add("show");
  });

  clearTimeout(window.toastTimeout);
  window.toastTimeout = setTimeout(() => {
    hideToast();
  }, duration);
}

function hideToast() {
  const toast = document.getElementById("toast");
  toast.classList.remove("show");
  setTimeout(() => {
    toast.style.display = "none";
  }, 300);
}
function renderLoginTable(dataArray) {
  const tbody = document.getElementById('loginTableBody');
  if (!dataArray.length) {
    tbody.innerHTML = '<tr><td colspan="5">No matching login data found.</td></tr>';
    return;
  }

  let html = '';
  dataArray.forEach((item, index) => {
    const email = item.email || '';
    const sanitizedEmail = sanitizeEmail(email);

    html += `<tr data-email="${email}">
      <td>${index + 1}</td>
      <td>${item.name || '-'}</td>
      <td>${email}</td>
      <td>${item.dateObj ? formatDateTime(item.dateObj) : item.loginRaw}</td>
      <td>
        <button class="logout-btn"
          onclick="showConfirmBox(this, '${email}', '${item.name || '-'}')">
          Logout
        </button>
        <button class="block-btn" data-email="${email}" onclick="toggleBlockUser(this)">
          Loading...
        </button>
      </td>
    </tr>`;
  });

  tbody.innerHTML = html;

  // Setelah render, update status tombol block/unblock
  dataArray.forEach(item => {
    const email = item.email || '';
    const btn = tbody.querySelector(`.block-btn[data-email="${email}"]`);
    if (btn) {
      isEmailBlocked(email).then(blocked => {
        btn.textContent = blocked ? "Unblock" : "Block";
        btn.classList.toggle("blocked", blocked);
      });
    }
  });
}

  function toggleBlockUser(button) {
  const email = button.getAttribute("data-email");
  isEmailBlocked(email).then(isBlocked => {
    const newStatus = !isBlocked;
    setEmailBlocked(email, newStatus)
      .then(() => {
        showToast(`${newStatus ? "Blocked" : "Unblocked"}: ${email}`, "success");
        button.textContent = newStatus ? "Unblock" : "Block";
        button.classList.toggle("blocked", newStatus);
      })
      .catch(err => {
        showToast(`Failed to update block status: ${err.message}`, "error");
      });
  });
}

  function loadLoginData() {
    const searchBtn = document.getElementById('searchBtn');
    searchBtn.classList.add('loading'); // 🔵 Aktifkan efek glowing tombol + icon

    dbRef.once('value', snapshot => {
      const data = snapshot.val();
      if (!data) {
        document.getElementById('loginTableBody').innerHTML = '<tr><td colspan="4">No login data found.</td></tr>';
        searchBtn.classList.remove('loading');
        return;
      }

      allLoginData = Object.values(data)
        .map(item => {
          const dateObj = parseDateString(item.loginAt);
          return {
            ...item,
            dateObj,
            loginRaw: item.loginAt || '-'
          };
        })
        .sort((a, b) => {
          if (!a.dateObj && !b.dateObj) return 0;
          if (!a.dateObj) return 1;
          if (!b.dateObj) return -1;
          return b.dateObj - a.dateObj;
        });

      const searchTerm = document.getElementById('searchInput')?.value || '';
      const filteredData = filterTable(searchTerm, allLoginData);
      renderLoginTable(filteredData);

      searchBtn.classList.remove('loading');
    }, error => {
      document.getElementById('loginTableBody').innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`;
      searchBtn.classList.remove('loading');
    });
  }

  function preserveScrollAndLoad() {
    const scrollY = window.scrollY;
    loadLoginData();
    setTimeout(() => {
      window.scrollTo({ top: scrollY, behavior: 'instant' });
    }, 50);
  }

  function setupSearchListener() {
    const input = document.getElementById('searchInput');
    if (input) {
      input.addEventListener('input', () => {
        const filteredData = filterTable(input.value, allLoginData);
        renderLoginTable(filteredData);
      });
    }
  }

  preserveScrollAndLoad();
  setInterval(preserveScrollAndLoad, 5000);
  window.onload = setupSearchListener;

  document.getElementById('searchBtn').addEventListener('click', () => {
    const query = document.getElementById('searchInput').value;
    const filtered = filterTable(query, allLoginData);
    renderLoginTable(filtered);
  });
function showConfirmAllBox(button) {
  const box = document.getElementById("confirmAllBox");

  // ✅ Kalau sedang tampil, klik lagi = tutup
  if (isConfirmAllVisible) {
    box.style.display = "none";
    box.classList.remove("show");
    isConfirmAllVisible = false;
    return;
  }

  const yesBtn = document.getElementById("confirmAllYes");
  const noBtn = document.getElementById("confirmAllNo");

  box.style.display = "block";
  box.classList.add("show");
  isConfirmAllVisible = true;

  const rect = button.getBoundingClientRect();
  const boxWidth = box.offsetWidth;
  let left = rect.left + (rect.width / 2) - (boxWidth / 2);

  const maxLeft = window.innerWidth - boxWidth - 10;
  if (left > maxLeft) left = maxLeft;
  if (left < 10) left = 10;

  box.style.top = `${rect.bottom + window.scrollY + 6}px`;
  box.style.left = `${left}px`;

  yesBtn.replaceWith(yesBtn.cloneNode(true));
  noBtn.replaceWith(noBtn.cloneNode(true));

  document.getElementById("confirmAllYes").onclick = () => {
    box.style.display = "none";
    box.classList.remove("show");
    isConfirmAllVisible = false;
    doForceLogoutAll();
  };

  document.getElementById("confirmAllNo").onclick = () => {
    box.style.display = "none";
    box.classList.remove("show");
    isConfirmAllVisible = false;
  };
}

function showConfirmBox(button, email, name = '-') {
  const box = document.getElementById("confirmBox");

  // ✅ Kalau email yang sama, maka sembunyikan
  if (box.style.display === "block" && currentConfirmEmail === email) {
    box.style.display = "none";
    box.classList.remove("show");
    currentConfirmEmail = null;
    return;
  }

  const yesBtn = document.getElementById("confirmYes");
  const noBtn = document.getElementById("confirmNo");

  currentConfirmEmail = email; // ✅ Simpan email saat ini

  document.getElementById("confirmUserName").textContent = name;
  document.getElementById("confirmUserEmail").textContent = email;

  box.style.display = "block";
  box.classList.add("show");

  const rect = button.getBoundingClientRect();
  const boxWidth = box.offsetWidth;
  let left = rect.left + (rect.width / 2) - (boxWidth / 2);

  const maxLeft = window.innerWidth - boxWidth - 10;
  if (left > maxLeft) left = maxLeft;
  if (left < 10) left = 10;

  box.style.top = `${rect.bottom + window.scrollY + 6}px`;
  box.style.left = `${left}px`;

  yesBtn.replaceWith(yesBtn.cloneNode(true));
  noBtn.replaceWith(noBtn.cloneNode(true));

  document.getElementById("confirmYes").onclick = () => {
    box.style.display = "none";
    box.classList.remove("show");
    currentConfirmEmail = null;
    forceLogoutUser(email);
  };

  document.getElementById("confirmNo").onclick = () => {
    box.style.display = "none";
    box.classList.remove("show");
    currentConfirmEmail = null;
  };
}
document.getElementById('forceLogoutAllBtn').addEventListener('click', function () {
  showConfirmAllBox(this);
});
 function doForceLogoutAll() {
  const updates = {
    time: Date.now(),
    users: allLoginData
      .filter(user => user.email)
      .map(user => user.email.replace(/\./g, "_"))
  };

  firebase.database().ref("logins/admin_override").set({
    forceLogoutAll: true,
    ...updates
  }).then(() => {
    // ✅ Tampilkan toast untuk setiap user dengan jeda
    let delay = 0;
    for (const emailSanitized of updates.users) {
      const originalEmail = emailSanitized.replace(/_/g, ".");
      setTimeout(() => {
        showToast(`Logout Successfuly! ${originalEmail}`, "success");
      }, delay);
      delay += 300; // jeda antar toast 300ms
    }

    // 🧹 Hapus trigger global setelah 3 detik
    setTimeout(() => {
      firebase.database().ref("logins/admin_override").remove();
    }, 3000);
  }).catch(err => {
    showToast(`logout Error!: ${originalEmail}`, "error");
  });
}
document.addEventListener('click', function (e) {
  const confirmBox = document.getElementById('confirmBox');
  const confirmAllBox = document.getElementById('confirmAllBox');

  // Tutup confirmBox jika klik di luar dan bukan tombol logout
  if (
    confirmBox.style.display === 'block' &&
    !confirmBox.contains(e.target) &&
    !e.target.closest('.logout-btn')
  ) {
    confirmBox.style.display = 'none';
    confirmBox.classList.remove('show');
    currentConfirmEmail = null;
  }
  if (
    confirmAllBox.style.display === 'block' &&
    !confirmAllBox.contains(e.target) &&
    !e.target.closest('#forceLogoutAllBtn')
  ) {
    confirmAllBox.style.display = 'none';
    confirmAllBox.classList.remove('show');
    isConfirmAllVisible = false;
  }
});
</script>
</body>
</html>
